<!-- templates/coupons/_modal_script.html -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is returning from a store visit
    checkForPendingCouponReveal();
    
    // Listen for window focus event to detect when user returns from store
    window.addEventListener('focus', function() {
        checkForPendingCouponReveal();
    });
    
    // Add event listeners for closing modals when clicking outside
    document.addEventListener('click', function(event) {
        // Check if the clicked element is a modal background
        if (event.target.classList.contains('fixed') && 
            event.target.classList.contains('inset-0') && 
            event.target.classList.contains('bg-black') && 
            event.target.classList.contains('bg-opacity-50')) {
            
            // Find the modal ID
            const modalId = event.target.id;
            if (modalId && modalId.startsWith('coupon-modal-')) {
                const slug = modalId.replace('coupon-modal-', '');
                closeCouponModal(slug);
            }
        }
    });
});

function copyCodeAndOpenStore(affiliateLink, code, slug, storeName) {
    // Get the button to disable it temporarily
    const button = document.getElementById("get-code-btn-" + slug);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Copying...';
    }
    
    // First copy the code to clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(function() {
            showCopyNotification();
            scheduleStoreOpen(affiliateLink, code, slug, storeName);
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, slug, affiliateLink, storeName);
        });
    } else {
        fallbackCopyTextToClipboard(code, slug, affiliateLink, storeName);
    }
}

function showCopyNotification() {
    const notification = document.createElement('div');
    notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    notification.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Coupon code copied to clipboard!';
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(function() {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(function() {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 500);
    }, 3000);
}

function scheduleStoreOpen(affiliateLink, code, slug, storeName) {
    // Store coupon information in sessionStorage
    sessionStorage.setItem('pendingCoupon', JSON.stringify({
        code: code,
        slug: slug,
        storeName: storeName,
        affiliateLink: affiliateLink,
        timestamp: new Date().getTime(),
        codeCopied: true
    }));
    
    // Show a secondary notification that we're opening the store
    const redirectNotification = document.createElement('div');
    redirectNotification.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    redirectNotification.innerHTML = '<i class="fas fa-external-link-alt mr-2"></i> Opening store in a new tab...';
    document.body.appendChild(redirectNotification);
    
    // Delay opening the store for 1.5 seconds to let user see the copy notification
    setTimeout(function() {
        // Open store in new tab
        window.open(affiliateLink, '_blank');
        
        // Remove the redirect notification
        if (document.body.contains(redirectNotification)) {
            redirectNotification.style.opacity = '0';
            redirectNotification.style.transition = 'opacity 0.5s';
            setTimeout(function() {
                if (document.body.contains(redirectNotification)) {
                    document.body.removeChild(redirectNotification);
                }
            }, 500);
        }
        
        // Update UI to show code and change button
        revealCodeAndChangeButton(code, slug);
    }, 2000);
}

function revealCodeAndChangeButton(code, slug) {
    // Update the original coupon card to show the code
    const originalCodeElement = document.getElementById("code-" + slug);
    const originalPlaceholder = document.getElementById("code-placeholder-" + slug);
    const getButton = document.getElementById("get-code-btn-" + slug);
    
    if (originalCodeElement && originalPlaceholder && getButton) {
        originalCodeElement.style.display = "block";
        originalPlaceholder.style.display = "none";
        
        // Change button to "Copy Code"
        getButton.innerHTML = '<i class="fas fa-copy mr-1"></i> Copy Code';
        getButton.disabled = false;
        getButton.onclick = function() {
            copyCodeAgain(code, slug);
        };
    }
    
    // For coupon detail page
    const mainCodeElement = document.getElementById("main-coupon-code");
    const mainPlaceholder = document.getElementById("main-coupon-placeholder");
    
    if (mainCodeElement && mainPlaceholder && getButton) {
        mainCodeElement.style.display = "block";
        mainPlaceholder.style.display = "none";
    }
}

function copyCodeAgain(code, slug) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(function() {
            showCopyNotification();
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, slug);
        });
    } else {
        fallbackCopyTextToClipboard(code, slug);
    }
}

function fallbackCopyTextToClipboard(text, slug, affiliateLink, storeName) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Make the textarea out of viewport
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        // Execute copy command
        var successful = document.execCommand('copy');
        if (successful) {
            showCopyNotification();
            if (affiliateLink && storeName) {
                scheduleStoreOpen(affiliateLink, text, slug, storeName);
            }
        } else {
            console.error('Unable to copy using fallback');
            alert('Copy failed. Please copy the code manually: ' + text);
            // Re-enable the button if copy failed
            const button = document.getElementById("get-code-btn-" + slug);
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-ticket-alt mr-1"></i> GET CODE';
            }
        }
    } catch (err) {
        console.error('Fallback error:', err);
        alert('Copy failed. Please copy the code manually: ' + text);
        // Re-enable the button if copy failed
        const button = document.getElementById("get-code-btn-" + slug);
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-ticket-alt mr-1"></i> GET CODE';
        }
    }
    
    document.body.removeChild(textArea);
}

function checkForPendingCouponReveal() {
    const pendingCoupon = sessionStorage.getItem('pendingCoupon');
    
    if (pendingCoupon) {
        try {
            const couponData = JSON.parse(pendingCoupon);
            
            // Check if the reveal happened within the last 30 minutes
            const thirtyMinutesAgo = new Date().getTime() - (30 * 60 * 1000);
            if (couponData.timestamp > thirtyMinutesAgo) {
                // If code was already copied, just show the modal
                if (couponData.codeCopied) {
                    showCouponModal(couponData.slug, couponData.code);
                } else {
                    // Otherwise, copy the code and show the modal
                    copyCodeAndOpenStore(couponData.affiliateLink, couponData.code, couponData.slug, couponData.storeName);
                }
                
                // Clear the pending coupon
                sessionStorage.removeItem('pendingCoupon');
                
                // Track the reveal event
                trackRevealEvent(couponData.slug, couponData.code);
            } else {
                // Expired, remove it
                sessionStorage.removeItem('pendingCoupon');
            }
        } catch (e) {
            console.error('Error parsing pending coupon data', e);
            sessionStorage.removeItem('pendingCoupon');
        }
    }
}

function showCouponModal(slug, code) {
    const modal = document.getElementById('coupon-modal-' + slug);
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
        
        // Auto-select the code for easier copying
        const codeElement = document.getElementById('modal-code-' + slug);
        if (codeElement) {
            // Create a range to select the text
            const range = document.createRange();
            range.selectNode(codeElement);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
        }
        
        // Also update the original coupon card to show the code
        revealCodeAndChangeButton(code, slug);
    }
}

function closeCouponModal(slug) {
    const modal = document.getElementById('coupon-modal-' + slug);
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
    }
}

function goToStore(affiliateLink) {
    window.open(affiliateLink, '_blank');
}

function copyCodeFromModal(code, couponId) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(function() {
            showCopyFeedback(couponId);
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, couponId);
        });
    } else {
        fallbackCopyTextToClipboard(code, couponId);
    }
}

function showCopyFeedback(couponId) {
    const feedbackElement = document.getElementById('copy-feedback-' + couponId);
    if (feedbackElement) {
        feedbackElement.classList.remove('hidden');
        setTimeout(function() {
            feedbackElement.classList.add('hidden');
        }, 3000);
    }
}

function trackRevealEvent(slug, code) {
    // Track the reveal_code event with proper parameters
    if (typeof trackEvent === 'function') {
        trackEvent('reveal_code', window.location.pathname, 'reveal_button', {
            slug: slug,
            coupon_code: code
        });
    }
}
</script>