{% extends 'base.html' %}
{% block title %}{{ coupon.title }} - CouponHub{% endblock %}

{% block content %}
<div class="card-bg rounded-xl shadow-xl overflow-hidden mb-8 border border-blue-700">
    <div class="p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div class="flex items-center mb-4 md:mb-0">
                {% if coupon.store.logo %}
                <img src="{{ coupon.store.logo.url }}" alt="{{ coupon.store.name }}" class="w-16 h-16 object-contain mr-4">
                {% else %}
                <div class="w-16 h-16 bg-blue-900/50 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-store text-blue-400 text-2xl"></i>
                </div>
                {% endif %}
                <div>
                    <h1 class="text-2xl font-bold text-blue-100">{{ coupon.title }}</h1>
                    <p class="text-blue-300">{{ coupon.store.name }} â€¢ {{ coupon.category.name }}</p>
                </div>
            </div>
            
            <div class="flex space-x-2">
                {% if coupon.is_verified %}
                <span class="bg-green-900/50 text-green-300 px-3 py-1 rounded-full text-sm">Verified</span>
                {% endif %}
                {% if coupon.is_featured %}
                <span class="bg-yellow-900/50 text-yellow-300 px-3 py-1 rounded-full text-sm">Featured</span>
                {% endif %}
                {% if coupon.is_expired %}
                <span class="bg-red-900/50 text-red-300 px-3 py-1 rounded-full text-sm">Expired</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Coupon Code Section (Prominent) -->
        <div class="mb-8">
            <div class="card-bg rounded-xl p-6 border border-blue-700">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <div>
                        <div class="text-3xl font-bold text-gradient mb-2">{{ coupon.discount_display }}</div>
                        <div class="text-blue-200">{{ coupon.store.name }}</div>
                    </div>
                    
                    {% if coupon.code %}
                    <div class="mt-4 md:mt-0">
                        <div class="text-sm text-blue-300 mb-2">Coupon Code</div>
                        <div class="flex items-center">
                            <div class="font-mono font-bold text-xl text-blue-100 bg-black/30 px-4 py-2 rounded-l-lg border border-blue-700" id="main-coupon-code">
                                {{ coupon.code }}
                            </div>
<button onclick="copyCode('{{ coupon.code }}', '{{ coupon.id }}', event)" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded-r-lg font-medium transition flex items-center">
    <i class="far fa-copy mr-2"></i> Copy Code
</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="mt-4 md:mt-0">
                        <div class="text-sm text-blue-300 mb-2">No Code Needed</div>
                        <div class="bg-black/30 px-4 py-2 rounded-lg border border-blue-700 text-blue-100 font-medium">
                            This deal is automatically applied at checkout
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex flex-wrap gap-3 mt-6">
                    {% if not coupon.is_expired %}
                    {% if coupon.affiliate_link %}
                    <a href="{{ coupon.affiliate_link }}" target="_blank" class="btn-gradient text-white px-6 py-3 rounded-lg font-semibold transition hover:opacity-90 flex items-center">
                        <i class="fas fa-external-link-alt mr-2"></i> Use This Deal
                    </a>
                    {% endif %}
                    
                    {% if user.is_authenticated %}
                    {% if is_saved %}
                    <a href="#" class="bg-blue-900/50 hover:bg-blue-800/50 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center">
                        <i class="fas fa-heart mr-2"></i> Saved
                    </a>
                    {% else %}
                    <a href="{% url 'save_coupon' coupon.id %}" class="bg-blue-900/50 hover:bg-blue-800/50 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center">
                        <i class="far fa-heart mr-2"></i> Save Coupon
                    </a>
                    {% endif %}
                    {% else %}
                    <a href="{% url 'login' %}" class="bg-blue-900/50 hover:bg-blue-800/50 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center">
                        <i class="far fa-user mr-2"></i> Login to Save
                    </a>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-blue-200 mb-2">Description</h2>
                    <p class="text-blue-300">{{ coupon.description }}</p>
                </div>
                
                {% if coupon.terms_and_conditions %}
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-blue-200 mb-2">Terms & Conditions</h2>
                    <p class="text-blue-300">{{ coupon.terms_and_conditions }}</p>
                </div>
                {% endif %}
                
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-blue-200 mb-2">Details</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card-bg p-4 rounded-lg border border-blue-700">
                            <p class="text-sm text-blue-400">Discount Type</p>
                            <p class="font-medium text-blue-100">{{ coupon.get_discount_type_display }}</p>
                        </div>
                        <div class="card-bg p-4 rounded-lg border border-blue-700">
                            <p class="text-sm text-blue-400">Coupon Type</p>
                            <p class="font-medium text-blue-100">{{ coupon.get_coupon_type_display }}</p>
                        </div>
                        <div class="card-bg p-4 rounded-lg border border-blue-700">
                            <p class="text-sm text-blue-400">Start Date</p>
                            <p class="font-medium text-blue-100">{{ coupon.start_date|date:"M d, Y" }}</p>
                        </div>
                        <div class="card-bg p-4 rounded-lg border border-blue-700">
                            <p class="text-sm text-blue-400">Expiry Date</p>
                            <p class="font-medium text-blue-100">
                                {% if coupon.expiry_date %}
                                {{ coupon.expiry_date|date:"M d, Y" }}
                                {% else %}
                                No expiration
                                {% endif %}
                            </p>
                        </div>
                        {% if coupon.minimum_purchase %}
                        <div class="card-bg p-4 rounded-lg border border-blue-700">
                            <p class="text-sm text-blue-400">Minimum Purchase</p>
                            <p class="font-medium text-blue-100">${{ coupon.minimum_purchase }}</p>
                        </div>
                        {% endif %}
                        {% if coupon.usage_limit %}
                        <div class="card-bg p-4 rounded-lg border border-blue-700">
                            <p class="text-sm text-blue-400">Usage Limit</p>
                            <p class="font-medium text-blue-100">{{ coupon.usage_count }}/{{ coupon.usage_limit }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-blue-200 mb-2">About {{ coupon.store.name }}</h2>
                    <p class="text-blue-300">{{ coupon.store.description|default:"No description available." }}</p>
                    <div class="mt-4">
                        <a href="{{ coupon.store.website }}" target="_blank" class="text-blue-400 hover:text-blue-300 font-medium flex items-center">
                            Visit Store Website <i class="fas fa-external-link-alt ml-2 text-sm"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-lg font-semibold text-blue-200 mb-4">Related Coupons</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for related_coupon in related_coupons %}
                        <div class="card-bg border border-blue-700 rounded-lg p-4 hover:shadow-lg transition">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-blue-100">{{ related_coupon.title }}</h3>
                                {% if related_coupon.is_verified %}
                                <span class="bg-green-900/50 text-green-300 text-xs px-2 py-1 rounded-full">Verified</span>
                                {% endif %}
                            </div>
                            <p class="text-blue-300 text-sm mb-3">{{ related_coupon.description|truncatewords:15 }}</p>
                            <div class="flex justify-between items-center">
                                <div class="text-lg font-bold text-gradient">{{ related_coupon.discount_display }}</div>
                                <a href="{% url 'coupon_detail' related_coupon.id %}" class="text-blue-400 hover:text-blue-300 text-sm font-medium">View Deal</a>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-span-full text-center py-4">
                            <p class="text-blue-400">No related coupons found.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div>
                <div class="card-bg border border-blue-700 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-blue-200 mb-4">How to Use This Coupon</h3>
                    <ol class="space-y-3">
                        <li class="flex items-start">
                            <div class="bg-blue-900/50 text-blue-200 rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0">1</div>
                            <p class="text-blue-300">Click on "Copy Code" button to copy the coupon code</p>
                        </li>
                        <li class="flex items-start">
                            <div class="bg-blue-900/50 text-blue-200 rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0">2</div>
                            <p class="text-blue-300">Click on "Use This Deal" to visit the store's website</p>
                        </li>
                        <li class="flex items-start">
                            <div class="bg-blue-900/50 text-blue-200 rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0">3</div>
                            <p class="text-blue-300">Add items to your shopping cart</p>
                        </li>
                        <li class="flex items-start">
                            <div class="bg-blue-900/50 text-blue-200 rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0">4</div>
                            <p class="text-blue-300">Paste the coupon code at checkout to get your discount</p>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyCode(code, couponId, event) {
    // Don't prevent default on mobile as it can interfere with the copy
    if (event && window.innerWidth > 768) {
        event.preventDefault();
    }
    
    // Modern clipboard API with fallback
    if (navigator.clipboard && window.isSecureContext) {
        // Use modern clipboard API in secure contexts
        navigator.clipboard.writeText(code).then(function() {
            showCopySuccess(event);
            trackCopyEvent(couponId, code);
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, event, couponId);
        });
    } else {
        // Use fallback method
        fallbackCopyTextToClipboard(code, event, couponId);
    }
}

function showCopySuccess(event) {
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
    button.classList.add('bg-green-600');
    
    setTimeout(function() {
        button.innerHTML = originalHTML;
        button.classList.remove('bg-green-600');
    }, 2000);
}

function trackCopyEvent(couponId, code) {
    // Track the copy_code event with proper parameters
    if (typeof trackEvent === 'function') {
        trackEvent('copy_code', window.location.pathname, 'copy_button', {
            coupon_id: couponId,
            coupon_code: code
        });
    }
}

function fallbackCopyTextToClipboard(text, event, couponId) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Make the textarea out of viewport
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        // Execute copy command
        var successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(event);
            trackCopyEvent(couponId, text);
        } else {
            console.error('Unable to copy using fallback');
            alert('Copy failed. Please copy the code manually: ' + text);
        }
    } catch (err) {
        console.error('Fallback error:', err);
        alert('Copy failed. Please copy the code manually: ' + text);
    }
    
    document.body.removeChild(textArea);
}
</script>
{% endblock %}