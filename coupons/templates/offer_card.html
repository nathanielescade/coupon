{% load coupon_extras %}
<div class="offer-card card-bg rounded-xl shadow-xl overflow-hidden border border-blue-700 transform transition-transform duration-300 hover:scale-[1.02]" itemscope itemtype="https://schema.org/Offer">
    <!-- Deal Type Badge -->
    <div class="absolute top-3 right-3 z-10">
        {% if offer.section == 'special' %}
            <span class="bg-purple-600 text-white text-xs px-2 py-1 rounded-full flex items-center">
                <i class="fas fa-star mr-1"></i> Special
            </span>
        {% elif offer.section == 'amazon' %}
            <span class="bg-yellow-600 text-white text-xs px-2 py-1 rounded-full flex items-center">
                <i class="fab fa-amazon mr-1"></i> Amazon
            </span>
        {% elif offer.section == 'deals' %}
            <span class="bg-red-600 text-white text-xs px-2 py-1 rounded-full flex items-center">
                <i class="fas fa-fire mr-1"></i> Hot Deal
            </span>
        {% elif offer.section == 'coupons' %}
            <span class="bg-green-600 text-white text-xs px-2 py-1 rounded-full flex items-center">
                <i class="fas fa-ticket-alt mr-1"></i> Coupon
            </span>
        {% endif %}
    </div>
    
    <div class="p-5">
        <div class="flex justify-between items-start mb-3">
            <div class="flex items-center">
                {% if offer.store.logo %}
                <img src="{{ offer.store.logo.url }}" alt="{{ offer.store.name }} logo" class="w-10 h-10 object-contain mr-2" itemprop="provider" itemscope itemtype="https://schema.org/Organization">
                    <meta itemprop="name" content="{{ offer.store.name }}">
                    <meta itemprop="url" content="{{ offer.store.website }}">
                </img>
                {% else %}
                <div class="w-10 h-10 bg-blue-900/50 rounded-lg flex items-center justify-center mr-2">
                    <i class="fas fa-store text-blue-400"></i>
                </div>
                {% endif %}
                <div>
                    <h3 class="font-bold text-blue-200 text-sm" itemprop="seller" itemscope itemtype="https://schema.org/Organization">
                        <a href="{% url 'store_detail' offer.store.slug %}" class="hover:text-blue-100 transition" itemprop="name">{{ offer.store.name }}</a>
                    </h3>
                    <p class="text-xs text-blue-400" itemprop="category">
                        <a href="{% url 'category_detail' offer.category.slug %}" class="hover:text-blue-300 transition">{{ offer.category.name }}</a>
                    </p>
                </div>
            </div>
           <div class="flex gap-1">
                {% if show_expiry and offer.is_expired %}
                    <span class="bg-red-900/50 text-red-300 text-xs px-2 py-1 rounded-full">Expired</span>
                {% elif offer.expiry_date|is_expiring_soon %}
                    <span class="bg-orange-900/50 text-orange-300 text-xs px-2 py-1 rounded-full">Expiring Soon</span>
                {% else %}
                    <!-- {% if offer.is_featured %}
                        <span class="bg-yellow-900/50 text-yellow-300 text-xs px-2 py-1 rounded-full">Featured</span>
                    {% endif %}
                    {% if offer.is_verified %}
                        <span class="bg-green-900/50 text-green-300 text-xs px-2 py-1 rounded-full">Verified</span>
                    {% endif %} -->
                {% endif %}
            </div>
        </div>
        
        <h3 class="font-bold text-blue-100 mb-2 {% if small_text %}text-sm{% else %}text-base{% endif %}" itemprop="name">{{ offer.title }}</h3>
        <p class="text-blue-300 mb-3 {% if small_text %}text-xs{% else %}text-sm{% endif %}" itemprop="description">{{ offer.description|truncatewords:15 }}</p>
        
        <!-- Offer Code Section (only for offers with codes) -->
        {% if offer.code and show_code|default:True %}
        <div class="mb-4 p-3 bg-black/30 rounded-lg border border-blue-700">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-xs text-blue-400 mb-1">Offer Code</div>
                    <div class="font-mono font-bold text-blue-100" id="code-{{ offer.slug }}" itemprop="couponCode" style="display:none;">{{ offer.code }}</div>
                    <div id="code-placeholder-{{ offer.slug }}" class="font-mono font-bold text-blue-400 flex items-center">
                        <i class="fas fa-cut mr-2"></i> Click to reveal
                    </div>
                </div>
                <button id="get-code-btn-{{ offer.slug }}" onclick="copyCodeAndOpenStore('{{ offer.affiliate_link }}', '{{ offer.code }}', '{{ offer.slug }}', '{{ offer.store.name }}')" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition flex items-center">
                    <i class="fas fa-ticket-alt mr-1"></i> GET CODE
                </button>
            </div>
        </div>
        {% endif %}
        
        <div class="flex justify-between items-center mb-4">
            <div class="text-lg font-bold text-gradient {% if small_text %}text-base{% endif %}" itemprop="price">
                {% if offer.discount_display %}
                    {{ offer.discount_display }}
                {% else %}
                    {{ offer.get_coupon_type_display }}
                {% endif %}
            </div>
            <div class="text-xs text-blue-400">
                {% if offer.expiry_date %}
                    {% if offer.is_expired %}
                        <span class="text-red-400">Expired</span>
                    {% else %}
                        {% if offer.expiry_date|countdown_from_3_days %}
                            Expires in: <span class="text-orange-400">{{ offer.expiry_date|countdown_from_3_days }}</span>
                        {% elif show_expiry %}
                            Expires: <time datetime="{{ offer.expiry_date|date:'c' }}">{{ offer.expiry_date|date:"M d, Y" }}</time>
                        {% else %}
                            <time datetime="{{ offer.expiry_date|date:'c' }}">{{ offer.expiry_date|date:"M d" }}</time>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        <meta itemprop="priceCurrency" content="USD">
        <meta itemprop="availability" content="https://schema.org/InStock" if offer.is_active and not offer.is_expired else "https://schema.org/OutOfStock">
        <meta itemprop="validFrom" content="{{ offer.start_date|date:'c' }}">
        {% if offer.expiry_date %}
        <meta itemprop="validThrough" content="{{ offer.expiry_date|date:'c' }}">
        {% endif %}
        <link itemprop="url" href="{% url 'deal_detail' offer.section offer.slug %}">
        
        <div class="flex space-x-2">
            {% if offer.affiliate_link %}
                {% if offer.code %}
                    <button onclick="copyCodeAndOpenStore('{{ offer.affiliate_link }}', '{{ offer.code }}', '{{ offer.slug }}', '{{ offer.store.name }}')" class="flex-1 btn-gradient text-white text-center py-2 rounded-lg {% if small_text %}text-sm{% endif %} font-medium transition hover:opacity-90" itemprop="url">
                        <i class="fas fa-ticket-alt mr-1"></i> GET CODE
                    </button>
                {% else %}
                    <button onclick="goToStore('{{ offer.affiliate_link }}', '{{ offer.slug }}', '{{ offer.store.name }}')" class="flex-1 btn-gradient text-white text-center py-2 rounded-lg {% if small_text %}text-sm{% endif %} font-medium transition hover:opacity-90" itemprop="url">
                        <i class="fas fa-shopping-cart mr-1"></i> GET DEAL
                    </button>
                {% endif %}
            {% else %}
                <a href="{% url 'deal_detail' offer.section offer.slug %}" class="flex-1 btn-gradient text-white text-center py-2 rounded-lg {% if small_text %}text-sm{% endif %} font-medium transition hover:opacity-90">
                    View Details
                </a>
            {% endif %}
            
            {% if user.is_authenticated %}
            <a href="{% url 'save_offer' offer.slug %}" class="w-10 h-8 flex items-center justify-center bg-blue-900/50 hover:bg-blue-800/50 rounded-lg transition">
                <i class="far fa-heart text-blue-300 {% if small_text %}text-sm{% endif %}"></i>
            </a>
            {% endif %}
        </div>
    </div>
</div>
<!-- Offer Code Modal (only for offers with codes) -->
{% if offer.code and show_code|default:True %}
<div id="offer-modal-{{ offer.slug }}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gradient-to-br from-blue-900 to-blue-800 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 border border-blue-600">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Your Offer Code</h3>
            <button onclick="closeOfferModal('{{ offer.slug }}')" class="text-blue-300 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-6">
            <p class="text-blue-200 mb-2">Use this code at checkout:</p>
            <div class="bg-black/30 p-4 rounded-lg border border-blue-600 flex justify-between items-center">
                <span class="font-mono text-xl font-bold text-white" id="modal-code-{{ offer.slug }}">{{ offer.code }}</span>
                <button onclick="copyCodeFromModal('{{ offer.code }}', '{{ offer.slug }}')" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded transition">
                    <i class="fas fa-copy mr-1"></i> Copy
                </button>
            </div>
            <div id="copy-feedback-{{ offer.slug }}" class="mt-2 text-green-400 text-sm hidden">
                <i class="fas fa-check-circle mr-1"></i> Code copied to clipboard!
            </div>
        </div>
        
        <div class="mb-6">
            <p class="text-blue-200 text-sm mb-2">This code is valid until:</p>
            <p class="text-white font-medium">
                {% if offer.expiry_date %}
                {{ offer.expiry_date|date:"F d, Y" }}
                {% else %}
                No expiration date
                {% endif %}
            </p>
        </div>
        
        <div class="flex space-x-3">
            <button onclick="goToStore('{{ offer.affiliate_link }}')" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white py-3 rounded-lg font-medium transition flex items-center justify-center">
                <i class="fas fa-shopping-cart mr-2"></i> Shop at {{ offer.store.name }}
            </button>
            <button onclick="closeOfferModal('{{ offer.slug }}')" class="w-12 h-12 flex items-center justify-center bg-blue-900/50 hover:bg-blue-800/50 rounded-lg transition">
                <i class="fas fa-times text-blue-300"></i>
            </button>
        </div>
        
        <div class="mt-4 text-xs text-blue-400 text-center">
            <p>By using this offer, you may be supporting our site through affiliate links</p>
        </div>
    </div>
</div>
{% endif %}
<!-- Deal Confirmation Modal (for deals without codes) -->
{% if not offer.code and offer.affiliate_link %}
<div id="deal-modal-{{ offer.slug }}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gradient-to-br from-blue-900 to-blue-800 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 border border-blue-600">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Redirecting to Store</h3>
            <button onclick="closeDealModal('{{ offer.slug }}')" class="text-blue-300 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-6">
            <div class="bg-black/30 p-4 rounded-lg border border-blue-600 mb-4">
                <div class="flex items-center mb-2">
                    {% if offer.store.logo %}
                    <img src="{{ offer.store.logo.url }}" alt="{{ offer.store.name }}" class="w-12 h-12 object-contain mr-3">
                    {% else %}
                    <div class="w-12 h-12 bg-blue-900/50 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-store text-blue-400"></i>
                    </div>
                    {% endif %}
                    <div>
                        <h4 class="font-bold text-white">{{ offer.store.name }}</h4>
                        <p class="text-blue-300 text-sm">{{ offer.title }}</p>
                    </div>
                </div>
            </div>
            
            <p class="text-blue-200 mb-4">You've been redirected to {{ offer.store.name }}. Check out their latest deals and promotions!</p>
        </div>
        
        <div class="flex space-x-3">
            <button onclick="goToStore('{{ offer.affiliate_link }}')" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white py-3 rounded-lg font-medium transition flex items-center justify-center">
                <i class="fas fa-shopping-cart mr-2"></i> Continue Shopping
            </button>
            <button onclick="closeDealModal('{{ offer.slug }}')" class="w-12 h-12 flex items-center justify-center bg-blue-900/50 hover:bg-blue-800/50 rounded-lg transition">
                <i class="fas fa-times text-blue-300"></i>
            </button>
        </div>
        
        <div class="mt-4 text-xs text-blue-400 text-center">
            <p>This deal may contain affiliate links that support our site at no extra cost to you</p>
        </div>
    </div>
</div>
{% endif %}
<script>
// Check if user is returning from a store visit
document.addEventListener('DOMContentLoaded', function() {
    checkForPendingOfferReveal();
    checkForPendingDealConfirmation();
    
    // Listen for window focus event to detect when user returns from store
    window.addEventListener('focus', function() {
        checkForPendingOfferReveal();
        checkForPendingDealConfirmation();
    });
});
function copyCodeAndOpenStore(affiliateLink, code, slug, storeName) {
    // Get the button to disable it temporarily
    const button = document.getElementById("get-code-btn-" + slug);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Copying...';
    }
    
    // First copy the code to clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(function() {
            showCopyNotification();
            scheduleStoreOpen(affiliateLink, code, slug, storeName);
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, slug, affiliateLink, storeName);
        });
    } else {
        fallbackCopyTextToClipboard(code, slug, affiliateLink, storeName);
    }
}
function goToStore(affiliateLink, slug, storeName) {
    // For deals without codes, store information in sessionStorage and open store
    sessionStorage.setItem('pendingDeal', JSON.stringify({
        slug: slug,
        storeName: storeName,
        affiliateLink: affiliateLink,
        timestamp: new Date().getTime()
    }));
    
    // Open store in new tab
    window.open(affiliateLink, '_blank');
    
    // Show a notification
    const notification = document.createElement('div');
    notification.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    notification.innerHTML = '<i class="fas fa-external-link-alt mr-2"></i> Opening store in a new tab...';
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(function() {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(function() {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 500);
    }, 3000);
}
function showCopyNotification() {
    const notification = document.createElement('div');
    notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    notification.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Offer code copied to clipboard!';
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(function() {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(function() {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 500);
    }, 3000);
}
function scheduleStoreOpen(affiliateLink, code, slug, storeName) {
    // Store offer information in sessionStorage
    sessionStorage.setItem('pendingOffer', JSON.stringify({
        code: code,
        slug: slug,
        storeName: storeName,
        affiliateLink: affiliateLink,
        timestamp: new Date().getTime(),
        codeCopied: true
    }));
    
    // Show a secondary notification that we're opening the store
    const redirectNotification = document.createElement('div');
    redirectNotification.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    redirectNotification.innerHTML = '<i class="fas fa-external-link-alt mr-2"></i> Opening store in a new tab...';
    document.body.appendChild(redirectNotification);
    
    // Delay opening the store for 1.5 seconds to let user see the copy notification
    setTimeout(function() {
        // Open store in new tab
        window.open(affiliateLink, '_blank');
        
        // Remove the redirect notification
        if (document.body.contains(redirectNotification)) {
            redirectNotification.style.opacity = '0';
            redirectNotification.style.transition = 'opacity 0.5s';
            setTimeout(function() {
                if (document.body.contains(redirectNotification)) {
                    document.body.removeChild(redirectNotification);
                }
            }, 500);
        }
        
        // Update UI to show code and change button
        revealCodeAndChangeButton(code, slug);
    }, 1500);
}
function revealCodeAndChangeButton(code, slug) {
    // Update the original offer card to show the code
    const originalCodeElement = document.getElementById("code-" + slug);
    const originalPlaceholder = document.getElementById("code-placeholder-" + slug);
    const getButton = document.getElementById("get-code-btn-" + slug);
    
    if (originalCodeElement && originalPlaceholder && getButton) {
        originalCodeElement.style.display = "block";
        originalPlaceholder.style.display = "none";
        
        // Change button to "Copy Code"
        getButton.innerHTML = '<i class="fas fa-copy mr-1"></i> Copy Code';
        getButton.disabled = false;
        getButton.onclick = function() {
            copyCodeAgain(code, slug);
        };
    }
}
function copyCodeAgain(code, slug) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(function() {
            showCopyNotification();
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, slug);
        });
    } else {
        fallbackCopyTextToClipboard(code, slug);
    }
}
function fallbackCopyTextToClipboard(text, slug, affiliateLink, storeName) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Make the textarea out of viewport
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        // Execute copy command
        var successful = document.execCommand('copy');
        if (successful) {
            showCopyNotification();
            if (affiliateLink && storeName) {
                scheduleStoreOpen(affiliateLink, text, slug, storeName);
            }
        } else {
            console.error('Unable to copy using fallback');
            alert('Copy failed. Please copy the code manually: ' + text);
            // Re-enable the button if copy failed
            const button = document.getElementById("get-code-btn-" + slug);
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-ticket-alt mr-1"></i> GET CODE';
            }
        }
    } catch (err) {
        console.error('Fallback error:', err);
        alert('Copy failed. Please copy the code manually: ' + text);
        // Re-enable the button if copy failed
        const button = document.getElementById("get-code-btn-" + slug);
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-ticket-alt mr-1"></i> GET CODE';
        }
    }
    
    document.body.removeChild(textArea);
}
function checkForPendingOfferReveal() {
    const pendingOffer = sessionStorage.getItem('pendingOffer');
    
    if (pendingOffer) {
        try {
            const offerData = JSON.parse(pendingOffer);
            
            // Check if the reveal happened within the last 30 minutes
            const thirtyMinutesAgo = new Date().getTime() - (30 * 60 * 1000);
            if (offerData.timestamp > thirtyMinutesAgo) {
                // If code was already copied, just show the modal
                if (offerData.codeCopied) {
                    showOfferModal(offerData.slug, offerData.code);
                } else {
                    // Otherwise, copy the code and show the modal
                    copyCodeAndOpenStore(offerData.affiliateLink, offerData.code, offerData.slug, offerData.storeName);
                }
                
                // Clear the pending offer
                sessionStorage.removeItem('pendingOffer');
                
                // Track the reveal event
                trackRevealEvent(offerData.slug, offerData.code);
            } else {
                // Expired, remove it
                sessionStorage.removeItem('pendingOffer');
            }
        } catch (e) {
            console.error('Error parsing pending offer data', e);
            sessionStorage.removeItem('pendingOffer');
        }
    }
}
function checkForPendingDealConfirmation() {
    const pendingDeal = sessionStorage.getItem('pendingDeal');
    
    if (pendingDeal) {
        try {
            const dealData = JSON.parse(pendingDeal);
            
            // Check if the deal was clicked within the last 30 minutes
            const thirtyMinutesAgo = new Date().getTime() - (30 * 60 * 1000);
            if (dealData.timestamp > thirtyMinutesAgo) {
                // Show the deal confirmation modal
                showDealModal(dealData.slug);
                
                // Clear the pending deal
                sessionStorage.removeItem('pendingDeal');
            } else {
                // Expired, remove it
                sessionStorage.removeItem('pendingDeal');
            }
        } catch (e) {
            console.error('Error parsing pending deal data', e);
            sessionStorage.removeItem('pendingDeal');
        }
    }
}
function setupModalCloseOnClickOutside(modalId, modalType) {
    const modal = document.getElementById(`${modalType}-modal-${modalId}`);
    if (!modal) return;
    
    // Add click event listener to the modal overlay
    modal.addEventListener('click', function(event) {
        // Check if the clicked element is the modal overlay (the background)
        if (event.target === modal) {
            if (modalType === 'offer') {
                closeOfferModal(modalId);
            } else if (modalType === 'deal') {
                closeDealModal(modalId);
            }
        }
    });
}
function showOfferModal(slug, code) {
    const modal = document.getElementById('offer-modal-' + slug);
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
        
        // Setup click outside to close functionality
        setupModalCloseOnClickOutside(slug, 'offer');
        
        // Auto-select the code for easier copying
        const codeElement = document.getElementById('modal-code-' + slug);
        if (codeElement) {
            // Create a range to select the text
            const range = document.createRange();
            range.selectNode(codeElement);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
        }
        
        // Also update the original offer card to show the code
        revealCodeAndChangeButton(code, slug);
    }
}
function closeOfferModal(slug) {
    const modal = document.getElementById('offer-modal-' + slug);
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
    }
}
function showDealModal(slug) {
    const modal = document.getElementById('deal-modal-' + slug);
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
        
        // Setup click outside to close functionality
        setupModalCloseOnClickOutside(slug, 'deal');
    }
}
function closeDealModal(slug) {
    const modal = document.getElementById('deal-modal-' + slug);
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
    }
}
function copyCodeFromModal(code, slug) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(function() {
            showCopyFeedback(slug);
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, slug);
        });
    } else {
        fallbackCopyTextToClipboard(code, slug);
    }
}
function showCopyFeedback(slug) {
    const feedbackElement = document.getElementById('copy-feedback-' + slug);
    if (feedbackElement) {
        feedbackElement.classList.remove('hidden');
        setTimeout(function() {
            feedbackElement.classList.add('hidden');
        }, 3000);
    }
}
function trackRevealEvent(slug, code) {
    // Track the reveal_code event with proper parameters
    if (typeof trackEvent === 'function') {
        trackEvent('reveal_code', window.location.pathname, 'reveal_button', {
            slug: slug,
            offer_code: code
        });
    }
}
</script>