{% load coupon_extras %}
<div class="coupon-card card-bg rounded-xl shadow-xl overflow-hidden border border-blue-700">
    <div class="p-5">
        <div class="flex justify-between items-start mb-3">
            <div class="flex items-center">
                {% if coupon.store.logo %}
                <img src="{{ coupon.store.logo.url }}" alt="{{ coupon.store.name }}" class="w-10 h-10 object-contain mr-2">
                {% else %}
                <div class="w-10 h-10 bg-blue-900/50 rounded-lg flex items-center justify-center mr-2">
                    <i class="fas fa-store text-blue-400"></i>
                </div>
                {% endif %}
                <div>
                    <h3 class="font-bold text-blue-200 text-sm">{{ coupon.store.name }}</h3>
                    <p class="text-xs text-blue-400">{{ coupon.category.name }}</p>
                </div>
            </div>
           <div class="flex gap-1">
    {% if show_expiry and coupon.is_expired %}
        <span class="bg-red-900/50 text-red-300 text-xs px-2 py-1 rounded-full">Expired</span>
    {% elif coupon.expiry_date|is_expiring_soon %}
        <span class="bg-orange-900/50 text-orange-300 text-xs px-2 py-1 rounded-full">Expiring Soon</span>
    {% else %}
        {% if coupon.is_featured %}
            <span class="bg-yellow-900/50 text-yellow-300 text-xs px-2 py-1 rounded-full">Featured</span>
        {% endif %}
        {% if coupon.is_verified %}
            <span class="bg-green-900/50 text-green-300 text-xs px-2 py-1 rounded-full">Verified</span>
        {% endif %}
    {% endif %}
</div>
        </div>
        
        <h3 class="font-bold text-blue-100 mb-2 {% if small_text %}text-sm{% endif %}">{{ coupon.title }}</h3>
        <p class="text-blue-300 mb-3 {% if small_text %}text-xs{% else %}text-sm{% endif %}">{{ coupon.description|truncatewords:15 }}</p>
        
        <!-- Coupon Code Section -->
        {% if coupon.code and show_code|default:True %}
        <div class="mb-4 p-3 bg-black/30 rounded-lg border border-blue-700">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-xs text-blue-400 mb-1">Coupon Code</div>
                    <div class="font-mono font-bold text-blue-100" id="code-{{ coupon.id }}">{{ coupon.code }}</div>
                </div>

                <button onclick="copyCode('{{ coupon.code }}', '{{ coupon.id }}', event)" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition flex items-center">
                    <i class="far fa-copy mr-1"></i> Copy
                </button>
            </div>
        </div>
        {% endif %}
        
        <div class="flex justify-between items-center mb-4">
            <div class="text-lg font-bold text-gradient {% if small_text %}text-base{% endif %}">{{ coupon.discount_display }}</div>
            <div class="text-xs text-blue-400">
                {% if coupon.expiry_date %}
                {% if show_expiry %}
                Expires: {{ coupon.expiry_date|date:"M d, Y" }}
                {% else %}
                {{ coupon.expiry_date|date:"M d" }}
                {% endif %}
                {% else %}
                No expiry
                {% endif %}
            </div>
        </div>
        
        <div class="flex space-x-2">
            {% if coupon.affiliate_link %}
            <a href="{{ coupon.affiliate_link }}" target="_blank" class="flex-1 btn-gradient text-white text-center py-2 rounded-lg {% if small_text %}text-sm{% endif %} font-medium transition hover:opacity-90">
                Use Deal
            </a>
            {% else %}
            <a href="{% url 'coupon_detail' coupon.id %}" class="flex-1 btn-gradient text-white text-center py-2 rounded-lg {% if small_text %}text-sm{% endif %} font-medium transition hover:opacity-90">
                View Details
            </a>
            {% endif %}
            {% if user.is_authenticated %}
            <a href="{% url 'save_coupon' coupon.id %}" class="w-10 h-8 flex items-center justify-center bg-blue-900/50 hover:bg-blue-800/50 rounded-lg transition">
                <i class="far fa-heart text-blue-300 {% if small_text %}text-sm{% endif %}"></i>
            </a>
            {% endif %}
        </div>
    </div>
</div>
<script>
function copyCode(code, couponId, event) {
    // Don't prevent default on mobile as it can interfere with the copy
    if (event && window.innerWidth > 768) {
        event.preventDefault();
    }
    
    // Modern clipboard API with fallback
    if (navigator.clipboard && window.isSecureContext) {
        // Use modern clipboard API in secure contexts
        navigator.clipboard.writeText(code).then(function() {
            showCopySuccess(event);
            trackCopyEvent(couponId, code);
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(code, event, couponId);
        });
    } else {
        // Use fallback method
        fallbackCopyTextToClipboard(code, event, couponId);
    }
}

function showCopySuccess(event) {
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
    button.classList.add('bg-green-600');
    
    setTimeout(function() {
        button.innerHTML = originalHTML;
        button.classList.remove('bg-green-600');
    }, 2000);
}

function trackCopyEvent(couponId, code) {
    // Track the copy_code event with proper parameters
    if (typeof trackEvent === 'function') {
        trackEvent('copy_code', window.location.pathname, 'copy_button', {
            coupon_id: couponId,
            coupon_code: code
        });
    }
}

function fallbackCopyTextToClipboard(text, event, couponId) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Make the textarea out of viewport
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        // Execute copy command
        var successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(event);
            trackCopyEvent(couponId, text);
        } else {
            console.error('Unable to copy using fallback');
            alert('Copy failed. Please copy the code manually: ' + text);
        }
    } catch (err) {
        console.error('Fallback error:', err);
        alert('Copy failed. Please copy the code manually: ' + text);
    }
    
    document.body.removeChild(textArea);
}
</script>